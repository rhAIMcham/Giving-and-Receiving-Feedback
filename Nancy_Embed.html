<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
        <title>Giving and Receiving Feedback - Nancy Call</title>
        <style>
            :root {
                --AIMblue: #4353A3;
                --darkBlue: #38416D;
                --teal: #5DC8B9;
                --cream: #F1EEDE;
                --grey: #e7e9ec;
                --rust: #AF4510;
                --navy: #12195C;
                --white: #ffffff;
                --lightBlue: #AEBAE4;
            }

            body {
                font-family: "IBM Plex Sans", sans-serif;
                margin: 0;
                background: radial-gradient(#12195c, #38416d);
                min-height: 100vh;
            }

            .containment {
                width: fit-content;
                margin: auto;
                display: flex;
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }

            @keyframes pulse-border {
                0% {
                    border-width: 2px;
                    border-color: var(--teal);
                }
                50% {
                    border-width: 4px;
                    border-color: rgba(93, 200, 185, 0.4); 
                }
                100% {
                    border-width: 2px;
                    border-color: var(--teal);
                }
            }

            .imgDisp {
                width: 400px;
                height: 400px;
                margin-top: 5rem;
                border: solid 2px var(--teal);
                border-radius: 500px;
                animation: pulse-border 2s ease-in-out infinite;
                overflow: hidden;
                display: flex;
                align-items: center;
                justify-content: center;
                background: var(--darkBlue);
            }

            img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .btn-bar {
                position: absolute;
                right: 30px;
                top: 30px;
                display: flex;
                flex-direction: column;
            }

            .agentStatus {
                margin: 30px;
                color: white;
            }

            #startButton {
                background: var(--teal); 
                font-weight: 400;
                color: black;  
            }

            #stopButton {
                background: var(--rust);
                font-weight: 400;
                color: white;
            }

            button {
                padding: 10px;
                margin: 3px;
                width: 100px;
                border-radius: 8px;
                border: none;
                box-shadow: 0px 0px 6px 0px rgba(255,255,255,0.15);
                cursor: pointer;
                transition: opacity 0.2s;
            }

            button:hover:not(:disabled) {
                opacity: 0.9;
            }

            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                background: var(--grey) !important;
                color: #666 !important;
                box-shadow: none;
            }

            .error-message {
                color: #ff6b6b;
                background: rgba(255, 107, 107, 0.1);
                padding: 10px;
                border-radius: 8px;
                margin-top: 20px;
                display: none;
            }

            .error-message.show {
                display: block;
            }
        </style>
    </head>
    <body>
        <div class="containment">
            <div class="imgDisp">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 400'%3E%3Ccircle cx='200' cy='200' r='200' fill='%2338416d'/%3E%3Ccircle cx='200' cy='150' r='60' fill='%235DC8B9'/%3E%3Cpath d='M 100 280 Q 200 350 300 280' stroke='%235DC8B9' stroke-width='8' fill='none' stroke-linecap='round'/%3E%3C/svg%3E" alt="Nancy">
            </div>
            <div class="btn-bar">
                <button id="startButton">Start call</button>
                <button id="stopButton" disabled>Leave call</button>
            </div>
            <div class="agentStatus">
                <p>Nancy is <span id="agentStatus">ready to call</span></p>
                <p>Status: <span id="connectionStatus">Disconnected</span></p>
            </div>
            <div class="error-message" id="errorMessage"></div>
        </div>

        <script type="module">
            // Import ElevenLabs SDK from unpkg CDN
            import { Conversation } from 'https://unpkg.com/@elevenlabs/client/dist/index.mjs';

            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            const connectionStatus = document.getElementById('connectionStatus');
            const agentStatus = document.getElementById('agentStatus');
            const errorMessage = document.getElementById('errorMessage');

            let conversation = null;

            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.classList.add('show');
                setTimeout(() => {
                    errorMessage.classList.remove('show');
                }, 5000);
            }

            async function startConversation() {
                try {
                    console.log('Starting conversation...');

                    // Request microphone permission
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    console.log('Microphone access granted');

                    // Start the conversation
                    conversation = await Conversation.startSession({
                        agentId: 'agent_9101k6hen56henmsmk66x8pvvabf',
                        onConnect: () => {
                            console.log('Connected to agent');
                            connectionStatus.textContent = 'Connected';
                            agentStatus.textContent = 'listening';
                            startButton.disabled = true;
                            stopButton.disabled = false;
                        },
                        onDisconnect: () => {
                            console.log('Disconnected from agent');
                            connectionStatus.textContent = 'Disconnected';
                            agentStatus.textContent = 'ready to call';
                            startButton.disabled = false;
                            stopButton.disabled = true;
                        },
                        onError: (error) => {
                            console.error('Conversation error:', error);
                            showError('Connection error: ' + error.message);
                        },
                        onModeChange: (mode) => {
                            console.log('Mode changed:', mode);
                            agentStatus.textContent = mode.mode === 'speaking' ? 'speaking' : 'listening';
                        }
                    });

                } catch (error) {
                    console.error('Failed to start conversation:', error);
                    showError('Failed to start: ' + error.message);
                    startButton.disabled = false;
                    stopButton.disabled = true;
                }
            }

            async function stopConversation() {
                try {
                    if (conversation) {
                        await conversation.endSession();
                        conversation = null;
                        console.log('Conversation ended');
                    }
                } catch (error) {
                    console.error('Error ending conversation:', error);
                    showError('Error ending call: ' + error.message);
                }
            }

            startButton.addEventListener('click', startConversation);
            stopButton.addEventListener('click', stopConversation);
        </script>
    </body>
</html>